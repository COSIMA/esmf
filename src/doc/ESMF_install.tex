% $Id: ESMF_install.tex,v 1.49.2.2 2006/08/25 04:51:38 theurich Exp $

%\section{Installing and Building the ESMF}
\subsection{ESMF Download Options}

Major releases of the ESMF software can be downloaded by following
the instructions on the 
the {\bf Downloads \& Documentation} link on the ESMF 
website, \htmladdnormallink{http://www.esmf.ucar.edu}{http://www.esmf.ucar.edu}.

The ESMF is distributed as a full source code tree.  You will need
to compile the code into the {\tt libesmf.a} library.
On some platforms a shared library, {\tt libesmf.so}, is also created.
Follow the instructions in the following sections
to build the library and link it with your application.

\subsection{Installation}
\label{InstallProcedures}

\input{ESMF_systemreq}

\subsubsection{ESMF Environment Variables}
\label{EnvironmentVariables}

The following is a full alphabetical list of all environment variables which
are used by the ESMF build system. In many cases only {\tt ESMF\_DIR} must be 
set. On Linux and Darwin systems {\tt ESMF\_COMPILER} and {\tt ESMF\_COMM} must
also be set to select the appropriate Fortran and C++ compilers and MPI 
implementation. The other variables have default values which work for
most systems.

\begin{description}

\item[ESMF\_ABI]
Possible value: {\tt 32}, {\tt 64}

If a system supports 32-bit and 64-bit (pointer wordsize) application binary
interfaces (ABIs), this variable can be set to select which ABI to use. Valid 
values are {\tt 32} or {\tt 64}. By default the most common ABI is chosen.

\item[ESMF\_ARRAY\_LITE]
Possible value: {\tt TRUE}, {\tt FALSE} (default)

Not normally set by user. ESMF auto-generates subroutine interfaces for a wide
variety of data arrays of different ranks, shapes, and types. If no data of
rank greater than 4D will be used, setting this variable to any value will
prevent ESMF from generating interfaces for 5D to 7D arrays. This will
shrink the amount of autogenerated code.

\item[ESMF\_BATCH]
Possible value: {\tt lsf.ibmpjl}

On IBM systems using the LSF batch system {\tt ESMF\_BATCH} is used to select
the correct method to launch parallel execution.

\item[ESMF\_BATCHOPTIONS]
Possible value: {\em system-dependent}

Variable used to pass system-specific queue options to the batch system. 
Typically the queue, project and limits are set using {\tt ESMF\_BATCHOPTIONS}.

\item[ESMF\_BOPT] 
Possible value: {\tt g}, {\tt O} (default)

This environment variable controls the build option. To make a debuggable
version of the library set {\tt ESMF\_BOPT} to {\tt g} before building. The 
default is {\tt O} (capital oh) which builds an optimized version of the
library. If {\tt ESMF\_BOPT} is {\tt O}, {\tt ESMF\_OPTLEVEL} can also be set
to a numeric value between 0 and 4 to select a specific optimization level.

\item[ESMF\_COMM]
Possible value: {\em system-dependent}

On systems with a vendor-supplied MPI communications library the vendor library 
is chosen by default for communications and {\tt ESMF\_COMM} need not be set.
For other systems (e.g. Linux or Darwin) a multitude of MPI implementations is
available and {\tt ESMF\_COMM} must be set to indicate which implementation is
used to build the ESMF library. Set {\tt ESMF\_COMM} according to your situation
to: {\tt mpich, mpich2, lam, openmpi} or {\tt intelmpi}. {\tt ESMF\_COMM} may
also be set to {\tt user} indicating that the user will set all the required
flags using advanced ESMF environment variables.

Alternatively, ESMF comes with a single-processor MPI-bypass library which is
the default for Linux and Darwin systems. To force the use of this bypass
library set {\tt ESMF\_COMM} equal to "mpiuni".

\item[ESMF\_COMPILER]
Possible value: {\em system-dependen}

The ESMF library build requires a working Fortran90 and C++ compiler. On 
platforms that don't come with a single vendor supplied compiler suite
(e.g. Linux or Darwin) {\tt ESMF\_COMPILER} must be set to select which Fortran
and C++ compilers are being used to build the ESMF library. Notice that setting
the {\tt ESMF\_COMPILER} variable does {\em not} affect how the compiler
executables are located on the system. {\tt ESMF\_COMPILER} (together with
{\tt ESMF\_COMM}) affect the name that is expected for the compiler executables.
Furthermore, the {\tt ESMF\_COMPILER} setting is used to select compiler and
linker flags consistent with the compilers indicated.

By default Fortran and C++ compiler executables are expected to be located in
a location contained in the user's {\tt PATH} environment variable. This means
that if you cannot locate the correct compiler executable via the {\tt which}
command on the shell prompt the ESMF build system won't find it either!

There are advanced ESMF environment variables that can be used to select 
specific compiler executables by specifying the full path. This can be used to
pick specific compiler executables without having to modify the {\tt PATH}
environment variable.

Use 'gmake info' to see which compiler executables the ESMF build system will
be using according to your environment variable settings.

To see possible values for {\tt ESMF\_COMPILER}, cd to 
{\tt \$ESMF\_DIR/build\_config} and list the directories there. The first part 
of each directory name corresponds to the output of 'uname -s' for this 
platform. The second part contains possible values for {\tt ESMF\_COMPILER}. In
some cases multiple combinations of Fortran and C++ compilers are possible, e.g.
there is {\tt intel} and {\tt intelgcc} available for Linux. Setting 
{\tt ESMF\_COMPILER} to {\tt intel} indicates that both Intel Fortran and 
C++ compilers are used, whereas {\tt intelgcc} indicates that the Intel Fortran
compiler is used in combination with GCC's C++ compiler.

If you do not find a configuration that matches your situation you will need to
port ESMF.

\item[ESMF\_EXHAUSTIVE] 
Possible value: {\tt ON}, {\tt OFF} (default)

Variable specifying how to compile the unit tests. If set to the value {\tt ON},
then all unit tests will be compiled and will be executed when the test is
run.  If unset or set to any other value, only a subset of the unit tests
will be included to verify basic functions. Note that this is a compile-time
selection, not a run-time option.

\item[ESMF\_NO\_INTEGER\_1\_BYTE]
Possible value: {\tt TRUE}, {\tt FALSE} (default)

Not normally set by user. Setting this variable to {\tt ON} will prevent ESMF
from generating data array interfaces for data types of 1-byte integers.

\item[ESMF\_NO\_INTEGER\_2\_BYTE] 
Possible value: {\tt TRUE}, {\tt FALSE} (default)

Same as {\tt ESMF\_NO\_INTEGER\_1\_BYTE} but for 2-byte integers.

\item[ESMF\_NO\_IOCODE] 
Possible value: {\tt FALSE} (default)

Currently ESMF does not support {\tt netCDF} I/O support.

\item[ESMF\_OS]
Possible value: output of {\tt uname -s} except for {\tt UNICOS/mp} where
{\tt ESMF\_OS} is {\tt Unicos}.

Not normally set by user. This variable indicates the system on which the ESMF
library is being built. For cross-compiling systems this may be different from 
the OS of the target platform. {\tt ESMF\_OS} is set automatically.

\item[ESMF\_PTHREADS]
Possible value: {\tt ON} (default), {\tt OFF}

This compile-time option controls ESMF's dependency on a functioning
Pthreads library. The default option is set to {\tt ON}. Setting this
variable to {\tt OFF} will turn ESMF's pthreads feature set off and a
stubs header file will be used instead of the Pthreads header during
library compilation. This may be necessary on systems that do not
supply a working Pthreads implementation. It may also be desirable to
disable ESMF's pthreads features for purpose of debugging ESMF
applications. Linking an ESMF application against a pthreads-disabled
ESMF library will result in run-time ESMF errors if the application
makes use of any ESMF pthreads features. The features offered by a
pthreads-enabled ESMF library form a proper superset of the
pthreads-disabled version. Specifically, a pthreads-disabled ESMF
library does not support ESMF multi-threading and concurrent execution
of components with overlapping PET lists. It also limits the
communication API as well as place some restrictions on {\em where}
Components may be created. See the VM section of the reference
document for more details on Pthreads in ESMF. (Notice that on some
platforms even a pthreads-{\em disabled} version of the ESMF library
will need to be linked against a functioning Pthreads library. In
those cases this dependency originates from the used compiler or the
MPI implementation.)

\item[ESMF\_SITE]
Possible value: {\em site string}, {\tt default}

Build configure file site name or the value default. If not set, then the value
of default is assumed. When including platform-specific files, this value is 
used as the third part of the directory name (parts 1 and 2 are the
ESMF\_OS value and ESMF\_COMPILER value, respectively.)

The Sourceforge {\tt esmfcontrib} repository contains makefiles which have 
already been customized for certain machines.  If one exists for your site 
and you wish to use it, download the corresponding files into the 
{\tt build\_contrib} directory and set {\tt ESMF\_SITE} to your location
(which corresponds to the last part of the directory name).  See the 
Sourceforge site {\tt http://sourceforge.net/projects/esmfcontrib} for more 
information.

\item[ESMF\_TESTWITHTHREADS]
Possible value: {\tt ON}, {\tt OFF} (default)

If this environment variable is set to {\tt ON} {\em before} the ESMF system
tests are build they will activate ESMF threading in their code. Specifically
each component will be executed using ESMF single threading instead of the
default non-threaded mode. The difference between non-threaded and ESMF
single threaded execution should be completely transparent. Notice that the
setting of {\tt ESMF\_TESTWITHTHREADS} does {\em not} alter ESMF's dependency
on Pthreads but tests ESMF threading features during the system tests. An
ESMF library that was compiled with disabled Pthread features (via the {\tt
ESMF\_PTHREADS} variable) will produce ESMF error messages during system test
execution if the system tests were compiled with {\tt ESMF\_TESTWITHTHREADS}
set to {\tt ON}.

\end{description}

Environment variables must be set in the user's shell or when calling gmake. It
is {\em not} necessary to edit ESMF makefiles or other build system files to set
these variables. Here is an example of setting an environment variable in the
csh/tcsh shell:

\begin{verbatim}
  setenv ESMF_ABI 32
\end{verbatim}

In bash/ksh shell environment variables are set this way:

\begin{verbatim}
  export ESMF_ABI=32
\end{verbatim}

Environment variables can also be set from the gmake command line:

\begin{verbatim}
  gmake ESMF_ABI=32
\end{verbatim}

\subsubsection{Supported Platforms}
\input{../../build/doc/user_arch}

Building the library for multiple architectures or options at the same
time is supported; building or running the tests or examples is restricted
to one platform/architecture at a time.  The output from the test cases
will be stored in a separate directories so the results will be kept 
separate for different architectures or options.

\subsubsection{Building the ESMF Libraries}
\label{BuildESMF}

% GNU make requirement.  File in build/doc
\input{../../build/doc/user_make}

Build the library with the command:
\begin{verbatim}
  gmake 
\end{verbatim}

%Build options that enable you to copy the library and *.mod files to
%specified directories are explained in Section~\ref{BuildOptions}. 

Makefiles throughout the framework are configured to allow users to
compile files only in the directory where {\tt gmake} is entered. Shared
libraries are rebuilt only if necessary. In addition the entire ESMF
framework may be built from any directory by entering {\tt gmake all},
assuming that all the environmental variables are set correctly as
described in Section~\ref{EnvironmentVariables}.

Users may also run examples or execute unit tests of specific classes
by changing directories to the desired class {\tt examples} or {\tt tests} 
directories and entering {\tt gmake run\_examples} or 
{\tt gmake run\_unit\_tests}, respectively.  For non-multiprocessor machines,
uni-processor targets are available as {\tt gmake run\_examples\_uni} or
{\tt gmake run\_unit\_tests\_uni}.

\subsubsection{Building the ESMF Documentation}
\label{BuildDocumentation}

The documentation consists of an {\it ESMF User's Guide}, 
{\it ESMF Requirements Document}, and 
{\it ESMF Reference Manual for Fortran}.  
\noindent To build documentation:
\begin{verbatim}
  gmake doc              ! Builds the manuals, including pdf and html.
\end{verbatim}

\noindent The resulting documentation files will be
located in the top level directory \${ESMF\_DIR}/doc.

%%
%% nsc 22jun04 - this is no longer true, so i'm commenting it out for now.
%% when we make it work again, comment this section back in and update it.
%% 
%% \noindent To build documentation for one module:
%% 
%% \noindent First change directory to the where the desired module's documentation 
%% resides; for example, to build the {\tt TimeMgr} documentation start
%% with:
%% 
%% \begin{verbatim}
%% cd $ESMF_DIR/src/Infrastructure/TimeMgr/doc
%% \end{verbatim}
%% 
%% \noindent Next issue one of the following commands:
%% \begin{verbatim}
%%   gmake pdf      ! Builds local pdf files.
%%   gmake html     ! Builds local html files.
%%   gmake alldoc   ! Builds all of the local documents.
%% \end{verbatim}
%% 
%% \noindent The output from this local documentation build is in the top 
%% level {\tt doc} directory, as with the previous commands.
%% 
%% 


