! $Id: ESMF_ArrayUTest.F90,v 1.15.4.2 2006/11/16 06:14:24 cdeluca Exp $
!
! Earth System Modeling Framework
! Copyright 2002-2006, University Corporation for Atmospheric Research,
! Massachusetts Institute of Technology, Geophysical Fluid Dynamics
! Laboratory, University of Michigan, National Centers for Environmental
! Prediction, Los Alamos National Laboratory, Argonne National Laboratory,
! NASA Goddard Space Flight Center.
! Licensed under the University of Illinois-NCSA License.
!
!==============================================================================
!
      program ESMF_ArrayUTest

!------------------------------------------------------------------------------
!

#include <ESMF_Macros.inc>

!==============================================================================
!BOP
! !PROGRAM: ESMF_ArrayTest - Test Array functionalities
!
! !DESCRIPTION:
!
! The code in this file drives F90 Array unit tests.
!
!EOP
!-----------------------------------------------------------------------------
! !USES:
      use ESMF_TestMod      ! test methods
      use ESMF_Mod
      implicit none

!------------------------------------------------------------------------------
! The following line turns the CVS identifier string into a printable variable.
      character(*), parameter :: version = &
      '$Id: ESMF_ArrayUTest.F90,v 1.15.4.2 2006/11/16 06:14:24 cdeluca Exp $'
!------------------------------------------------------------------------------

!   ! Local variables
    type(ESMF_Array) :: array1
    real(ESMF_KIND_R8), dimension(:,:), pointer :: f90ptr1
    integer :: width, attribute
    integer :: counts(2), lbounds(2), ubounds(2)
    real :: attribute4
    logical :: tf_result
    type(ESMF_ArraySpec) :: arrayspec
    type(ESMF_DataType) :: att_datatype
    type(ESMF_DataKind) :: att_datakind


    ! individual test failure message
    character(ESMF_MAXSTR) :: failMsg
    character(ESMF_MAXSTR) :: name, array_name
    integer :: rc, status, att_count, result = 0

    
    call ESMF_TestStart(ESMF_SRCLINE, rc=rc)



!-------------------------------------------------------------------------------
!   !  Create an Array Test
 
    !NEX_UTest
    allocate(f90ptr1(10,20))
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Create Array Test"
    array1 =  ESMF_ArrayCreate(f90ptr1, ESMF_DATA_REF, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!   !  Destroy an Array Test

    !NEX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Destroy Array Test"
    call ESMF_ArrayDestroy(array1, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!   !  Check memory status test - this memory should not be deallocated 
!   !  by the array destroy call, so the associated() call should return true.

    !NEX_UTest
    write(failMsg, *) "Data area should not be deallocated"
    write(name, *) "Data not deallocated at destroy time"
    tf_result = associated(f90ptr1)
    call ESMF_Test((tf_result), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!   !  Deallocate the user-allocated memory (framework should *not* have
!   !   deallocated it at array destroy time).

    !NEX_UTest
    write(failMsg, *) "Did not return Fortran status code = 0" 
    write(name, *) "Deallocate memory"
    deallocate(f90ptr1, stat=status)
    call ESMF_Test((status.eq.0), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!   !  Check memory status test - this memory should now be deallocated,
!   !  so the associated() call should return false.

    !NEX_UTest
    write(failMsg, *) "Data area should be deallocated"
    write(name, *) "Data not deallocated"
    tf_result = associated(f90ptr1)
    call ESMF_Test((.not. tf_result), name, failMsg, result, ESMF_SRCLINE)

#ifdef ESMF_EXHAUSTIVE
!-------------------------------------------------------------------------------
!   !  Create an Array Test with data copy

    !EX_UTest
    allocate(f90ptr1(10,20))
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Create Array Test"
    array1 = ESMF_ArrayCreate(f90ptr1, ESMF_DATA_COPY, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!   !  Set Array Name Test
 
    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Set Array Name Test"
    call ESMF_ArraySet(array1, name="SAM", rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!   !  Get Array Name Test
 
    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS or returned wrong name" 
    write(name, *) "Get Array Name Test"
    call ESMF_ArrayGet(array1, name=array_name, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS.and.array_name.eq."SAM"), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!   !  Destroy an Array Test

    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Destroy Array Test"
    call ESMF_ArrayDestroy(array1, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!-------------------------------------------------------------------------------
!   !  Deallocate the user-allocated memory (framework should *not* have
!   !   deallocated it at array destroy time).

    !EX_UTest
    write(failMsg, *) "Did not return Fortran status code = 0" 
    write(name, *) "Deallocate memory"
    deallocate(f90ptr1, stat=status)
    call ESMF_Test((status.eq.0), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!   !  Create an Array with a halo width
 
    !EX_UTest
    allocate(f90ptr1(-5:5,20:40))
    f90ptr1(:,:) = 1.0
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Create Array with HaloWidth Test"
    array1 = ESMF_ArrayCreate(f90ptr1, ESMF_DATA_COPY, haloWidth=2, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!   !  Get Halo Width back
 
    !EX_UTest
    write(name, *) "Get Array HaloWidth Test"
    call ESMF_ArrayGet(array1, haloWidth=width, rc=rc)
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)
    !EX_UTest
    write(name, *) "Verify Array HaloWidth Test"
    write(failMsg, *) "Halo Width not 2" 
    call ESMF_Test((width.eq.2), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Print an Array

    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Print an Array Test"
    call ESMF_ArrayPrint(array1, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!-------------------------------------------------------------------------------
!  !  Get Attribute count from an Array

    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Set an Attribute in an Array Test"
    call ESMF_ArrayGetAttributeCount(array1, attribute, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Verify Attribute count from an Array

    !EX_UTest
    write(failMsg, *) "Attribute count is incorrect" 
    write(name, *) "Verify Attribute count from an Array Test"
    call ESMF_Test((attribute.eq.0), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Set an Attribute in an Array

    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Set an Attribute in an Array Test"
    call ESMF_ArraySetAttribute(array1, "test_attribute", 123456789, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Set an Attribute in an Array

    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Set an Attribute in an Array Test"
    call ESMF_ArraySetAttribute(array1, "test_attribute1", 0, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!
   !  Set an Attribute in an Array
    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Set an Attribute in an Array Test"
    call ESMF_ArraySetAttribute(array1, "test_attribute2", 0.0, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Set an Attribute in an Array

    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Set an Attribute in an Array Test"
    call ESMF_ArraySetAttribute(array1, "test_attribute3", 6789, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Set an Attribute in an Array

    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Set an Attribute in an Array Test"
    call ESMF_ArraySetAttribute(array1, "test_attribute4", 5.87, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Get Attribute count from an Array

    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Get an Attribute from an Array Test"
    call ESMF_ArrayGetAttributeCount(array1, attribute, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Verify Attribute count from an Array

    !EX_UTest
    write(failMsg, *) "Attribute count is incorrect" 
    write(name, *) "Verify Attribute count from an Array Test"
    call ESMF_Test((attribute.eq.5), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Get an Attribute from an Array

    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Get an Attribute from an Array Test"
    call ESMF_ArrayGetAttribute(array1, "test_attribute", attribute, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Verify the value of the Attribute

    !EX_UTest
    write(failMsg, *) "Attribute value is wrong" 
    write(name, *) "Verify Attribute value from an Array Test"
    call ESMF_Test((attribute.eq.123456789), name, failMsg, result, ESMF_SRCLINE)
!-------------------------------------------------------------------------------
!  !  Get Attribute Info from an Array

    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Get Attribute Info from an Array Test"
    call ESMF_ArrayGetAttributeInfo(array1, "test_attribute", &
                                    datatype=att_datatype, &
                                    datakind=att_datakind, &
                                    count=att_count, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Verify datatype of Attribute

    !EX_UTest
    write(failMsg, *) "Attribute datatype is wrong" 
    write(name, *) "Verify Attribute datatype from an Array Test"
    call ESMF_Test((att_datatype.eq.ESMF_DATA_INTEGER), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Verify datakind of Attribute

    !EX_UTest
    write(failMsg, *) "Attribute datakind is wrong" 
    write(name, *) "Verify Attribute datakind from an Array Test"
    call ESMF_Test((att_datakind.eq.ESMF_I4), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Verify count of Attribute

    !EX_UTest
    write(failMsg, *) "Attribute count is wrong" 
    write(name, *) "Verify Attribute count from an Array Test"
    call ESMF_Test((att_count.eq.1), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Get an Attribute from an Array with wrong data type

    !EX_UTest
    write(failMsg, *) "Should not return ESMF_SUCCESS" 
    write(name, *) "Get a Wrong Data type Attribute from an Array Test"
    call ESMF_ArrayGetAttribute(array1, "test_attribute4", attribute, rc=rc)
    call ESMF_Test((rc.ne.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Get an Attribute from an Array

    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Get an Attribute from an Array Test"
    call ESMF_ArrayGetAttribute(array1, "test_attribute4", attribute4, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Verify the value of the Attribute

    !EX_UTest
    write(failMsg, *) "Attribute value is wrong" 
    write(name, *) "Verify Attribute value from an Array Test"
    call ESMF_Test((attribute4.eq.5.87), name, failMsg, result, ESMF_SRCLINE)
    print *, "test_attribute4 = ", attribute4

!-------------------------------------------------------------------------------
!  !  Get Attribute Info from an Array

    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Get Attribute Info from an Array Test"
    call ESMF_ArrayGetAttributeInfo(array1, "test_attribute4", &
                                    datatype=att_datatype, &
                                    datakind=att_datakind, &
                                    count=att_count, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Verify datatype of Attribute

    !EX_UTest
    write(failMsg, *) "Attribute datatype is wrong" 
    write(name, *) "Verify Attribute datatype from an Array Test"
    call ESMF_Test((att_datatype.eq.ESMF_DATA_REAL), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Verify datakind of Attribute

    !EX_UTest
    write(failMsg, *) "Attribute datakind is wrong" 
    write(name, *) "Verify Attribute datakind from an Array Test"
    call ESMF_Test((att_datakind.eq.ESMF_R4), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Verify count of Attribute

    !EX_UTest
    write(failMsg, *) "Attribute count is wrong" 
    write(name, *) "Verify Attribute count from an Array Test"
    call ESMF_Test((att_count.eq.1), name, failMsg, result, ESMF_SRCLINE)
    print *, "Attribute count =", att_count

!-------------------------------------------------------------------------------
!   !  Destroy an Array Test

    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Destroy Array Test"
    call ESMF_ArrayDestroy(array1, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!   !  Deallocate the user-allocated memory (framework should *not* have
!   !   deallocated it at array destroy time).

    !EX_UTest
    write(failMsg, *) "Did not return Fortran status code = 0" 
    write(name, *) "Deallocate memory"
    deallocate(f90ptr1, stat=status)
    call ESMF_Test((status.eq.0), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!-------------------------------------------------------------------------------
!   !  Create an ArraySpec for use below
 
    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Create ArraySpec for use in ArrayCreate"
    call ESMF_ArraySpecSet(arrayspec, rank=2, type=ESMF_DATA_REAL, &
                             kind=ESMF_R8, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!   !  Create an Array with data allocation inside the framework
 
    !EX_UTest
    nullify(f90ptr1)
    counts(1) = 10
    counts(2) = 20
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Create Array with data allocated by framework"
    array1 = ESMF_ArrayCreate(f90ptr1, counts, haloWidth=2, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Print an Array

    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Print an Array Test"
    call ESMF_ArrayPrint(array1, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!   !  Destroy an Array Test

    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Destroy Array Test"
    call ESMF_ArrayDestroy(array1, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!   !  Check memory status test - this memory should be deallocated 
!   !  by the array destroy call, so the associated() call should return false.

    !EX_UTest
    write(failMsg, *) "Data area should be deallocated"
    write(name, *) "Data not deallocated at destroy time"
    tf_result = associated(f90ptr1)
    call ESMF_Test((.not. tf_result), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!   !  Create an Array with data allocation inside the framework
 
    !EX_UTest
    nullify(f90ptr1)
    counts(1) = 11
    counts(2) = 36 
    lbounds(1) = -3
    lbounds(2) = -3
    ubounds(1) = 8
    ubounds(2) = 33
    width = 3
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Create Array with data allocated by framework"
    array1 = ESMF_ArrayCreate(f90ptr1, counts, width, lbounds, ubounds, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!  !  Print an Array

    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Print an Array Test"
    call ESMF_ArrayPrint(array1, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!   !  Destroy an Array Test

    !EX_UTest
    write(failMsg, *) "Did not return ESMF_SUCCESS" 
    write(name, *) "Destroy Array Test"
    call ESMF_ArrayDestroy(array1, rc=rc)
    call ESMF_Test((rc.eq.ESMF_SUCCESS), name, failMsg, result, ESMF_SRCLINE)

!-------------------------------------------------------------------------------
!   !  Check memory status test - this memory should be deallocated 
!   !  by the array destroy call, so the associated() call should return false.

    !EX_UTest
    write(failMsg, *) "Data area should be deallocated"
    write(name, *) "Data not deallocated at destroy time"
    tf_result = associated(f90ptr1)
    call ESMF_Test((.not. tf_result), name, failMsg, result, ESMF_SRCLINE)

#endif

    call ESMF_TestEnd(result, ESMF_SRCLINE)

    end program ESMF_ArrayUTest
    
!\end{verbatim}
    
